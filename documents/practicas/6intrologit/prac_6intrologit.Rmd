---
title: "Practica 6: Introduccióna Logit"
subtitle: "Estadistica Multivariada - Sociología FACSO Universidad de Chile"
author: "Juan Carlos Castillo & Alejandro Plaza"
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Refs:
https://cran.r-project.org/web/packages/jtools/vignettes/summ.html
Fields, Cap. 9: comparing two means
Miles, understanding and using statistics


#Introducción



```{r message=FALSE, warning=FALSE}
library(haven)
library(data.table)
library(sjmisc)
library(sjlabelled)
library(ggplot2)
library(dplyr)
el2 <- read_dta("C:/Users/Fondecyt R. Sociales/Dropbox/ELSOC/6_Envios_ELSOC/6_A_Comunidad_COES_ELSOC_2016_2017_y_Merge/6_Datos_Formato_Stata_14/ELSOC_W02_v2.00_Stata14.dta")
table(el2$c36)
```



# Inferencía estadística

En primer lugar revisamos los estadísticos descriptivos de las variables de interés.

```{r message=FALSE, results='asis'}
#codificación de intención de voto
el2$voto<- car::Recode(el2$c36, "-999:-888=0; 8:10=0; else=1")
el2$voto<- remove_labels(el2$voto, labels = c(`Alejandro Guillier` = 1))
table(el2$voto)

```

##concepto de razón o ratio
```{r}
#intención de voto por sexo
table(el2$voto)
prop.table(table(el2$voto))

```
La tabla muestra que 1167 personas se declaran dispuestos a a votar en las elecciones presidenciales de noviembre de 2017. En terminos de porcentajes esto expresa el 47% de la muestra (1167/2473=0.47) en contraste con el 53% de la muestra que no declara disposición de ir a votar (1306/2473=0.53).

Esto se puede expresar de la misma forma en términos de razón.
```{r}
1167/1306
#0.8935681 existen 0.89 personas que votan por cada una que no lo hace
#O alternartivamente por cada 100 personas que no van a votar, exitirian 89 personas que sí están dispuestas.

##Tambien se puede hacer la interpretación al revés
1306/1167
#1.119109 existen 1.12 personas que no tienen disposición de ir a votar por cada una que esta dispuesta.


```


La razón o ratio es el coenciente entre dos cantidades y señala cuantas veces una cantidad es mayor o menor respecto a la otra

## voto en relación al género.
```{r}
addmargins(table(el2$voto,el2$m0_sexo))
round(prop.table(table(el2$voto,el2$m0_sexo),2),2) #perfil columna
```

Según esto los hombres participan más que las mujeres, 49% versus 46%
Tambien se puede expresar en términos de razón:

la razón de los hombres que tienen disposición a votar frente a los que no es 
```{r}
0.49/0.51
```
existen 0.96 hombres que estarían dispuestos a votar por cada hombre que no estaría dispuesto.

y para mujeres
```{r}
0.46/0.54
```
existen 0.85 mujeres que estarían dispuestos a votar por cada mujer que no estaría dispuesto.

en términos generales esto se le suele llamar **ODD**

$$0dd =\frac{p}{q}=\frac{p}{1-p}$$


el término odd refiere a la razón que se establece entre la ocurriencia de un evento (o su probabilidad) respecto al suceso de su no ocurrencia.

a través de los ratios se puede responder ¿cuántos más estan dispuestos las mujeres a votar en relación a los hombres?

```{r}
prop.table(table(el2$voto,el2$m0_sexo),2)
odd_voto_H<-0.4900105/0.5099895
odd_voto_M<-0.4605782/0.5394218

odd_voto_M/odd_voto_H

```

La probabilidad de encontrar una mujer que este dispuesta a votar sobre una que no lo este es de 0.89 veces respecto el caso de los hombres. Es decir la probabilidad, se reduce a 11% respecto de los hombres (1-0.89).

Este término se le llama Odd ratio (o razón de ODD, o razón de momios) y puede interpretarse como una razón de probabilidades. EN nuestro caso la probabilidad de encontrar entre las mujeres una que este dispues a votar es menor que en el caso de los hombres. Cuando el Odd ratio alcanza un valor de 1 quiere decir que no hay diferencias



$$OddRatio=\frac{odd_{a}}{odd_{b}}=\frac{\frac{p_{a}}{(1-p_{a})}}{\frac{p_{b}}{(1-p_{b})}}$$



## La relación entre odd y proporción


$$odd=\frac{p}{1-p}$$
$$p=\frac{odd}{1+odd}$$


Los Odds pueden variar de 0 a $+\infty$. Teniendo en cuenta de que p varia de 0 a 1, por lo tanto cuando p está muy cerca a 1:

$$odd=\frac{p}{1-p}=\frac{1}{0}=+\infty$$


Y en el caso inverso

$$odd=\frac{p}{1-p}=\frac{0}{1}=0$$

A partir del Odd es posible definir el logit, es decir el logaritmo natural del Odd [^1] 
[^1]: En regresión logística se emplea el logaritmo natural o neperiano cuya base es el número *e*, un número irracional cuyo valor aproximado es 2,718. El logaritmo natural de un número x, notado como ln(x), es el exponente al que debe ser elevado el número *e* para obtener x.


El logit puede tomar cualquier valor real entre $-\infty$ y $+\infty$, y permite una lectura simétrica de la relación entre proporciones.


Vamos a tomar el caso de elsoc. En elsoc el 38% de los encuestados son hombres y el 62% son mujeres.
```{r}
prop.table(table(el2$m0_sexo))
(odd_h<-0.3845532/0.6154468)
(odd_m<-0.6154468/0.3845532)

```

Se definomos *p* como la proporción de hombres, el odd será de 0.62(0.38/0.62), mientras que si definimos *p* como la proporción de mujeres, el odd será de  1.06(0.62/0.38)

Cuando *p* es menor que *q*, el Odd se moverá entre 0 y 1. mientras que cuando p>q el odd se moverá entre 1 y $+\infty$.

Sin embargo, mediante a la transformación logarítmica del odd los valores son comparables sin importar cuál sea la categória tomada para el cálculo de la proporición.

```{r}
log(odd_h)
log(odd_m)

```

```{r warning=FALSE, message=FALSE,results='asis'}


p<-seq(0,1,by=0.01)
odd<- p/(1-p)
logit<- log(p/(1-p))
dat<- as.data.frame(cbind(p,odd,logit))
library(tidyverse)
library(hrbrthemes)
library(plotly)
library(babynames)
library(viridis)

dat %>%
  ggplot( aes(x=p, y=odd)) +
    geom_line(color="#69b3a2") +
    ggtitle("odd segun valores de p") +
    ylab("odd") +
    theme_ipsum()

dat %>%
  ggplot( aes(x=p, y=logit)) +
    geom_line(color="#69b3a2") +
    ggtitle("logit segun valores de p") +
    ylab("logit") +
    theme_ipsum()


```



